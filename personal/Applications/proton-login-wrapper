#!/bin/bash

# Wrapper script for Proton Login Autostart
# Notifies user of start, waits for network, logs in, and ensures SSH agent is ready

SSH_AGENT_SOCKET="$HOME/.ssh/proton-pass-agent.sock"
SSH_AGENT_WAIT_SECONDS=30
MAX_NETWORK_WAIT_SECONDS=30
NETWORK_CHECK_HOST="1.1.1.1"
LOG_FILE="/tmp/proton-login-wrapper.log"

# Clear log file on fresh run
: > "$LOG_FILE"

log_msg() {
    local level="$1"
    shift
    local ts
    ts="$(date +"%Y-%m-%d %H:%M:%S")"
    local msg="[$ts] [$level] $*"
    echo "$msg"
    echo "$msg" >> "$LOG_FILE"
}

log_info() {
    log_msg "INFO" "$@"
}

log_warn() {
    log_msg "WARN" "$@"
}

log_error() {
    log_msg "ERROR" "$@"
}

notify_user() {
    local title="$1"
    local message="$2"
    local urgency="${3:-low}"

    log_info "Notification: $title - $message (urgency: $urgency)"

    if command -v notify-send &>/dev/null; then
        notify-send --urgency="$urgency" "$title" "$message" 2>/dev/null
    elif command -v osascript &>/dev/null; then
        osascript -e "display notification \"$message\" with title \"$title\"" 2>/dev/null
    fi
}

is_ssh_agent_active() {
    if [ ! -S "$SSH_AGENT_SOCKET" ]; then
        return 1
    fi

    SSH_AUTH_SOCK="$SSH_AGENT_SOCKET" ssh-add -l >/dev/null 2>&1
    local ret=$?
    
    if [ $ret -le 1 ]; then
        return 0
    fi
    return 1
}

stop_stale_ssh_agents() {
    if ! command -v pgrep >/dev/null 2>&1; then
        return
    fi

    local pattern="pass-cli ssh-agent start"
    local stale_pids
    stale_pids=$(pgrep -f "$pattern" || true)

    if [ -n "$stale_pids" ]; then
        log_warn "Terminating stale SSH agent processes: $stale_pids"
        echo "$stale_pids" | xargs kill -9 >/dev/null 2>&1 || true
    fi
}

start_ssh_agent() {
    log_info "Ensuring Proton Pass SSH agent is running."

    if is_ssh_agent_active; then
        export SSH_AUTH_SOCK="$SSH_AGENT_SOCKET"
        notify_user "SSH Agent" "✅ SSH agent already running at $SSH_AGENT_SOCKET."
        return 0
    fi

    log_warn "SSH agent not responding. Cleaning up socket and old processes."
    stop_stale_ssh_agents
    rm -f "$SSH_AGENT_SOCKET"
    mkdir -p "$(dirname "$SSH_AGENT_SOCKET")"
    chmod 700 "$(dirname "$SSH_AGENT_SOCKET")"

    log_info "Starting SSH agent in background..."
    nohup pass-cli ssh-agent start --socket-path "$SSH_AGENT_SOCKET" --vault-name Main >/dev/null 2>&1 &
    local agent_pid=$!
    
    log_info "Waiting up to ${SSH_AGENT_WAIT_SECONDS}s for SSH agent socket to appear (PID: $agent_pid)."
    for ((i = 0; i < SSH_AGENT_WAIT_SECONDS; i++)); do
        sleep 1
        if is_ssh_agent_active; then
            export SSH_AUTH_SOCK="$SSH_AGENT_SOCKET"
            notify_user "SSH Agent" "✅ SSH agent ready at $SSH_AGENT_SOCKET."
            return 0
        fi
        
        if ! kill -0 "$agent_pid" 2>/dev/null; then
             log_warn "Process $agent_pid vanished, but still checking for socket..."
        fi
    done

    log_error "SSH agent failed to start or socket not available after ${SSH_AGENT_WAIT_SECONDS}s."
    notify_user "SSH Agent Error" "❌ SSH agent failed to start." "critical"
    return 1
}

log_info "Starting Proton Pass login wrapper."
notify_user "Proton Pass" "Starting login verification..."

log_info "Waiting for network connectivity..."
RETRY=0
while ! ping -c 1 -W 1 "$NETWORK_CHECK_HOST" &>/dev/null; do
    ((RETRY++))
    if [ $RETRY -ge $MAX_NETWORK_WAIT_SECONDS ]; then
        log_warn "Network check timed out. Continuing..."
        break
    fi
    sleep 1
done

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
PROTON_LOGIN_SCRIPT="$SCRIPT_DIR/proton-login"

if [ ! -x "$PROTON_LOGIN_SCRIPT" ]; then
    log_error "Could not find executable proton-login script."
    exit 1
fi

log_info "Invoking proton-login script."
"$PROTON_LOGIN_SCRIPT" >> "$LOG_FILE" 2>&1
EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    if pass-cli test >/dev/null 2>&1; then
        notify_user "Proton Pass" "✅ Startup checks passed. Ready."
        start_ssh_agent
    else
        notify_user "Proton Pass Warning" "⚠️ Login test failed." "critical"
    fi
else
    log_error "proton-login failed with exit code $EXIT_CODE."
fi
